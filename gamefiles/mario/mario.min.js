var Mario={SpriteCuts:{CreateBlackFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(0))},CreateRedFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(8))},CreateGreenFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(16))},CreateBlueFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(24))},CreateYellowFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(32))},CreatePinkFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(40))},CreateCyanFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(48))},CreateWhiteFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(56))},GetCharArray:function(i){for(var t=[],e=0,e=32;e<127;e++)t[e]={X:8*(e-32),Y:i};return t},GetBackgroundSheet:function(){for(var i=[],t=0,e=0,s=Enjine.Resources.Images.background.width/32,h=Enjine.Resources.Images.background.height/32,t=0;t<s;t++)for(i[t]=[],e=0;e<h;e++)i[t][e]={X:32*t,Y:32*e,Width:32,Height:32};return i},GetLevelSheet:function(){for(var i=[],t=0,e=0,s=Enjine.Resources.Images.map.width/16,h=Enjine.Resources.Images.map.height/16,t=0;t<s;t++)for(i[t]=[],e=0;e<h;e++)i[t][e]={X:16*t,Y:16*e,Width:16,Height:16};return i}},Tile:{BlockUpper:1,BlockAll:2,BlockLower:4,Special:8,Bumpable:16,Breakable:32,PickUpable:64,Animated:128,Behaviors:[],LoadBehaviors:function(){for(var i=[0,20,28,0,130,130,130,130,2,2,2,2,2,0,138,0,162,146,154,162,146,146,154,146,2,0,2,2,2,0,2,0,192,192,192,192,0,0,0,0,2,2,0,0,0,0,2,0,0,0,0,0,0,0,0,0,2,2],t=0,t=58;t<128;t++)i[t]=0;for(i[128]=2,i[129]=2,i[130]=2,i[131]=0,i[132]=1,i[133]=1,i[134]=1,i[135]=0,i[136]=2,i[137]=2,i[138]=2,i[139]=0,i[140]=2,i[141]=2,i[142]=2,i[143]=0,i[144]=2,i[145]=0,i[146]=2,i[147]=0,i[148]=0,i[149]=0,i[150]=0,i[151]=0,i[152]=2,i[153]=2,i[154]=2,i[155]=0,i[156]=2,i[157]=2,i[158]=2,i[159]=0,i[160]=2,i[161]=2,i[162]=2,i[163]=0,i[164]=0,i[165]=0,i[166]=0,i[167]=0,i[168]=2,i[169]=2,i[170]=2,i[171]=0,i[172]=2,i[173]=2,i[174]=2,i[175]=0,i[176]=2,i[177]=2,i[178]=2,i[179]=0,i[180]=1,i[181]=1,i[182]=1,t=183;t<224;t++)i[t]=0;for(i[224]=1,i[225]=1,i[226]=1,t=227;t<256;t++)i[t]=0;this.Behaviors=i}},LevelType:{Overground:0,Underground:1,Castle:2},Odds:{Straight:0,HillStraight:1,Tubes:2,Jump:3,Cannons:4},Level:function(i,t){this.Width=i,this.Height=t,this.ExitY=this.ExitX=10,this.Map=[],this.Data=[],this.SpriteTemplates=[];for(var e=0,s=0,e=0;e<this.Width;e++)for(this.Map[e]=[],this.Data[e]=[],this.SpriteTemplates[e]=[],s=0;s<this.Height;s++)this.Map[e][s]=0,this.Data[e][s]=0,this.SpriteTemplates[e][s]=null}};Mario.Level.prototype={Update:function(){for(var i=0,t=0,i=0;i<this.Width;i++)for(t=0;t<this.Height;t++)0<this.Data[i][t]&&this.Data[i][t]--},GetBlockCapped:function(i,t){return i<0&&(i=0),t<0&&(t=0),i>=this.Width&&(i=this.Width-1),t>=this.Height&&(t=this.Height-1),this.Map[i][t]},GetBlock:function(i,t){return i<0&&(i=0),t<0?0:(i>=this.Width&&(i=this.Width-1),t>=this.Height&&(t=this.Height-1),this.Map[i][t])},SetBlock:function(i,t,e){i<0||t<0||i>=this.Width||t>=this.Height||(this.Map[i][t]=e)},SetBlockData:function(i,t,e){i<0||t<0||i>=this.Width||t>=this.Height||(this.Data[i][t]=e)},IsBlocking:function(i,t,e,s){return i=this.GetBlock(i,t),t=0<(Mario.Tile.Behaviors[255&i]&Mario.Tile.BlockAll),t|=0<s&&0<(Mario.Tile.Behaviors[255&i]&Mario.Tile.BlockUpper),t|=s<0&&0<(Mario.Tile.Behaviors[255&i]&Mario.Tile.BlockLower)},GetSpriteTemplate:function(i,t){return i<0||t<0||i>=this.Width||t>=this.Height?null:this.SpriteTemplates[i][t]},SetSpriteTemplate:function(i,t,e){i<0||t<0||i>=this.Width||t>=this.Height||(this.SpriteTemplates[i][t]=e)}},Mario.BackgroundGenerator=function(i,t,e,s){this.Width=i,this.Height=t,this.Distant=e,this.Type=s},Mario.BackgroundGenerator.prototype={SetValues:function(i,t,e,s){this.Width=i,this.Height=t,this.Distant=e,this.Type=s},CreateLevel:function(){var i=new Mario.Level(this.Width,this.Height);switch(this.Type){case Mario.LevelType.Overground:this.GenerateOverground(i);break;case Mario.LevelType.Underground:this.GenerateUnderground(i);break;case Mario.LevelType.Castle:this.GenerateCastle(i)}return i},GenerateOverground:function(i){for(var t,e=this.Distant?4:6,s=this.Distant?2:1,h=(Math.floor(Math.random()*e),0),a=Math.floor(Math.random()*e)+s,r=0,o=0,n=0,n=2,r=0;r<this.Width;r++){for(h=a;h===a;)a=Math.floor(Math.random()*e)+s;for(o=0;o<this.Height;o++)n=h<a?a:h,o<(t=h<a?h:a)?this.Distant?(n=o<2?o:2,i.SetBlock(r,o,4+8*n)):i.SetBlock(r,o,5):o===t?(n=t===a?0:1,n+=this.Distant?2:0,i.SetBlock(r,o,n)):o===n?(n=t===a?0:1,n+=this.Distant?2:0,i.SetBlock(r,o,n+16)):(n=n<o?1:0,t===h&&(n=1-n),n+=this.Distant?2:0,i.SetBlock(r,o,n+8))}},GenerateUnderground:function(i){var t=0,e=0,s=0,h=0;if(this.Distant)for(var a=0,t=0;t<this.Width;t++)for(Math.random()<.75&&(a=1-a),e=0;e<this.Height;e++)s=a,((h=e-2)<0||4<h)&&(h=2,s=0),i.SetBlock(t,e,4+s+8*(3+h));else for(t=0;t<this.Width;t++)for(e=0;e<this.Height;e++)s=t%2,((h=e-1)<0||7<h)&&(h=7,s=0),0===s&&1<h&&h<5&&(s=-1,h=0),i.SetBlock(t,e,6+s+8*h)},GenerateCastle:function(i){var t=0,e=0,s=0,h=0;if(this.Distant)for(t=0;t<this.Width;t++)for(e=0;e<this.Height;e++)s=t%2,2<(h=e-1)&&h<5?h=2:5<=h&&(h-=2),h<0?(s=0,h=5):4<h?(s=1,h=5):s<1&&3===h?(s=0,h=3):s<1&&0<h&&h<3&&(s=0,h=2),i.SetBlock(t,e,1+s+8*(h+4));else for(t=0;t<this.Width;t++)for(e=0;e<this.Height;e++)s=t%3,2<(h=e-1)&&h<5?h=2:5<=h&&(h-=2),h<0?(s=1,h=5):4<h?(s=2,h=5):s<2&&4===h?(s=2,h=4):s<2&&0<h&&h<4&&(s=4,h=-3),i.SetBlock(t,e,1+s+8*(h+3))}},Mario.BackgroundRenderer=function(i,t,e,s){this.Level=i,this.Width=t,this.Distance=s,this.TilesY=1+(e/32|0),this.Background=Mario.SpriteCuts.GetBackgroundSheet()},Mario.BackgroundRenderer.prototype=new Enjine.Drawable,Mario.BackgroundRenderer.prototype.Draw=function(i,t){for(var e,s=t.X/this.Distance,h=0,a=0,r=(s+this.Width)/32|0,h=s/32|0;h<=r;h++)for(a=0;a<this.TilesY;a++)e=255&this.Level.GetBlock(h,a),e=this.Background[e%8][e/8|0],i.drawImage(Enjine.Resources.Images.background,e.X,e.Y,e.Width,e.Height,(h<<5)-s|0,a<<5|0,e.Width,e.Height)},Mario.ImprovedNoise=function(i){this.P=[],this.Shuffle(i)},Mario.ImprovedNoise.prototype={Shuffle:function(){for(var i,t,e=[],s=0,s=0;s<256;s++)e[s]=s;for(s=0;s<256;s++)i=(255*Math.random()|0)+s,t=e[s],e[s]=e[i],e[i]=t,this.P[s+256]=this.P[s]=e[s]},PerlinNoise:function(i,t){for(var e,s=0,h=0,s=0;s<8;s++)e=64/(1<<s),h+=this.Noise(i/e,t/e,128)/(1<<s);return h},Noise:function(i,t,e){var s=255&(0|i),h=255&(0|t),a=255&(0|e);i-=0|i,t-=0|t,e-=0|e;var r=this.Fade(i),o=this.Fade(t),n=this.Fade(e),l=this.P[s]+h,d=this.P[l]+a,l=this.P[l+1]+a,h=this.P[1+s]+h,s=this.P[h]+a,a=this.P[h+1]+a;return this.Lerp(n,this.Lerp(o,this.Lerp(r,this.Grad(this.P[d],i,t,e),this.Grad(this.P[s],i-1,t,e)),this.Lerp(r,this.Grad(this.P[l],i,t-1,e),this.Grad(this.P[a],i-1,t-1,e))),this.Lerp(o,this.Lerp(r,this.Grad(this.P[d+1],i,t,e-1),this.Grad(this.P[s+1],i-1,t,e-1)),this.Lerp(r,this.Grad(this.P[l+1],i,t-1,e-1),this.Grad(this.P[a+1],i-1,t-1,e-1))))},Fade:function(i){return i*i*i*(i*(6*i-15)+10)},Lerp:function(i,t,e){return t+i*(e-t)},Grad:function(i,t,e,s){var h=(i&=15)<8?t:e,t=i<4?e:12===i||14===i?t:s;return(0==(1&i)?h:-h)+(0==(2&i)?t:-t)}},Mario.NotchSprite=function(i){this.YPicO=this.XPicO=this.YPic=this.XPic=this.Ya=this.Xa=this.Y=this.X=this.YOld=this.XOld=0,this.PicHeight=this.PicWidth=32,this.YFlip=this.XFlip=!1,this.Visible=!0,this.Image=i,this.Delta=0,this.SpriteTemplate=null,this.Layer=1},Mario.NotchSprite.prototype=new Enjine.Drawable,Mario.NotchSprite.prototype.Draw=function(i){var t,e;this.Visible&&(t=(this.XOld+(this.X-this.XOld)*this.Delta|0)-this.XPicO,e=(this.YOld+(this.Y-this.YOld)*this.Delta|0)-this.YPicO,i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,this.XPic*this.PicWidth,this.YPic*this.PicHeight,this.PicWidth,this.PicHeight,this.XFlip?320-t-this.PicWidth:t,this.YFlip?240-e-this.PicHeight:e,this.PicWidth,this.PicHeight),i.restore())},Mario.NotchSprite.prototype.Update=function(i){this.XOld=this.X,this.YOld=this.Y,this.Move(),this.Delta=i},Mario.NotchSprite.prototype.UpdateNoMove=function(){this.XOld=this.X,this.YOld=this.Y,this.Delta=0},Mario.NotchSprite.prototype.Move=function(){this.X+=this.Xa,this.Y+=this.Ya},Mario.NotchSprite.prototype.GetX=function(i){return(this.XOld+(this.X-this.XOld)*i|0)-this.XPicO},Mario.NotchSprite.prototype.GetY=function(i){return(this.YOld+(this.Y-this.YOld)*i|0)-this.YPicO},Mario.NotchSprite.prototype.CollideCheck=function(){},Mario.NotchSprite.prototype.BumpCheck=function(){},Mario.NotchSprite.prototype.Release=function(){},Mario.NotchSprite.prototype.ShellCollideCheck=function(){return!1},Mario.NotchSprite.prototype.FireballCollideCheck=function(){return!1},Mario.Character=function(){this.Fire=this.Large=!1,this.Coins=0,this.Lives=3,this.LevelString="none",this.AirInertia=this.GroundInertia=.89,this.RunTime=0,this.Sliding=this.Ducking=this.MayJump=this.OnGround=this.WasOnGround=!1,this.YJumpSpeed=this.XJumpSpeed=this.JumpTime=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=null,this.InvulnerableTime=this.WinTime=this.DeathTime=this.YDeathPos=this.XDeathPos=this.PowerUpTime=this.Facing=0,this.Carried=null,this.NewFire=this.NewLarge=this.LastFire=this.LastLarge=!1},Mario.Character.prototype=new Mario.NotchSprite(null),Mario.Character.prototype.Initialize=function(i){this.World=i,this.X=32,this.RunTime=this.PowerUpTime=this.Y=0,this.Sliding=this.Ducking=this.MayJump=this.OnGround=this.WasOnGround=!1,this.YJumpSpeed=this.XJumpSpeed=this.JumpTime=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=i,this.InvulnerableTime=this.WinTime=this.DeathTime=this.YDeathPos=this.XDeathPos=this.PowerUpTime=this.Facing=0,this.Carried=null,this.SetLarge(this.Large,this.Fire)},Mario.Character.prototype.SetLarge=function(i,t){t&&(i=!0),i||(t=!1),this.LastLarge=this.Large,this.LastFire=this.Fire,this.Large=i,this.Fire=t,this.NewLarge=this.Large,this.NewFire=this.Fire,this.Blink(!0)},Mario.Character.prototype.Blink=function(i){this.Large=i?this.NewLarge:this.LastLarge,this.Fire=i?this.NewFire:this.LastFire,this.Large?(this.Image=this.Fire?Enjine.Resources.Images.fireMario:Enjine.Resources.Images.mario,this.XPicO=16,this.YPicO=31,this.PicWidth=this.PicHeight=32):(this.Image=Enjine.Resources.Images.smallMario,this.XPicO=8,this.YPicO=15,this.PicWidth=this.PicHeight=16)},Mario.Character.prototype.Move=function(){var i;0<this.WinTime?(this.WinTime++,this.Ya=this.Xa=0):0<this.DeathTime?(this.DeathTime++,this.DeathTime<11?this.Ya=this.Xa=0:11===this.DeathTime?this.Ya=-15:this.Ya+=2,this.X+=this.Xa,this.Y+=this.Ya):0!==this.PowerUpTime?(0<this.PowerUpTime?(this.PowerUpTime--,this.Blink(0==(1&(this.PowerUpTime/3|0)))):(this.PowerUpTime++,this.Blink(0==(1&(-this.PowerUpTime/3|0)))),0===this.PowerUpTime&&(this.World.Paused=!1),this.CalcPic()):(0<this.InvulnerableTime&&this.InvulnerableTime--,this.Visible=0==(1&(this.InvulerableTime/2|0)),this.WasOnGround=this.OnGround,i=Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)?1.2:.6,this.OnGround&&(this.Ducking=!(!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Down)||!this.Large)),2<this.Xa&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)||this.JumpTime<0&&!this.OnGround&&!this.Sliding?this.JumpTime<0?(this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.JumpTime++):this.OnGround&&this.MayJump?(Enjine.Resources.PlaySound("jump"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=7,this.Ya=this.JumpTime*this.YJumpSpeed,this.Sliding=this.OnGround=!1):this.Sliding&&this.MayJump?(Enjine.Resources.PlaySound("jump"),this.XJumpSpeed=6*-this.Facing,this.YJumpSpeed=-2,this.JumpTime=-6,this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.Sliding=this.OnGround=!1,this.Facing=-this.Facing):0<this.JumpTime&&(this.Xa+=this.XJumpSpeed,this.Ya=this.JumpTime*this.YJumpSpeed,this.JumpTime--):this.JumpTime=0,Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&!this.Ducking&&(1===this.Facing&&(this.Sliding=!1),this.Xa-=i,0<=this.JumpTime&&(this.Facing=-1)),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)&&!this.Ducking&&(-1===this.Facing&&(this.Sliding=!1),this.Xa+=i,0<=this.JumpTime&&(this.Facing=1)),(!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)||this.Ducking||this.Ya<0||this.OnGround)&&(this.Sliding=!1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)&&this.CanShoot&&this.Fire&&this.World.FireballsOnScreen<2&&(Enjine.Resources.PlaySound("fireball"),this.World.AddSprite(new Mario.Fireball(this.World,this.X+6*this.Facing,this.Y-20,this.Facing))),this.CanShoot=!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A),this.MayJump=(this.OnGround||this.Sliding)&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S),this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,Math.abs(this.Xa)<.5&&(this.Xa=this.RunTime=0),this.CalcPic(),this.Sliding&&(this.World.AddSprite(new Mario.Sparkle(this.World,(this.X+4*Math.random()-2|0)+8*this.Facing,(this.Y+4*Math.random()|0)-24,2*Math.random()-1,Math.random(),0,1,5)),this.Ya*=.5),this.OnGround=!1,this.SubMove(this.Xa,0),this.SubMove(0,this.Ya),this.Y>16*this.World.Level.Height+16&&this.Die(),this.X<0&&(this.Xa=this.X=0),this.X>16*this.World.Level.ExitX&&this.Win(),this.X>16*this.World.Level.Width&&(this.X=16*this.World.Level.Width,this.Xa=0),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=3),null===this.Carried||(this.Carried.X*=this.X+8*this.Facing,this.Carried.Y*=this.Y-2,Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A))||(this.Carried.Release(this),this.Carried=null))},Mario.Character.prototype.CalcPic=function(){var i=0,t=0;if(this.Large?(3===(i=(this.RunTime/20|0)%4)&&(i=1),null===this.Carried&&10<Math.abs(this.Xa)&&(i+=3),null!==this.Carried&&(i+=10),this.OnGround||(i=null!==this.Carried?12:10<Math.abs(this.Xa)?7:6)):(i=(this.RunTime/20|0)%2,null===this.Carried&&10<Math.abs(this.Xa)&&(i+=2),null!==this.Carried&&(i+=8),this.OnGround||(i=null!==this.Carried?9:10<Math.abs(this.Xa)?5:4)),this.OnGround&&(-1===this.Facing&&0<this.Xa||1===this.Facing&&this.Xa<0)&&((1<this.Xa||this.Xa<-1)&&(i=this.Large?9:7),3<this.Xa||this.Xa<-3))for(t=0;t<3;t++)this.World.AddSprite(new Mario.Sparkle(this.World,this.X+8*Math.random()-4|0,this.Y+4*Math.random()|0,2*Math.random()-1,-1*Math.random(),0,1,5));this.Large?(this.Ducking&&(i=14),this.Height=this.Ducking?12:24):this.Height=12,this.XPic=i},Mario.Character.prototype.SubMove=function(i,t){for(var e=!1;8<i;){if(!this.SubMove(8,0))return!1;i-=8}for(;i<-8;){if(!this.SubMove(-8,0))return!1;i+=8}for(;8<t;){if(!this.SubMove(0,8))return!1;t-=8}for(;t<-8;){if(!this.SubMove(0,-8))return!1;t+=8}return 0<t&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)||this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t))&&(e=!0),t<0&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0),0<i&&(this.Sliding=!0,this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i+this.Width,this.Y+t-(this.Height/2|0),i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)?e=!0:this.Sliding=!1),i<0&&(this.Sliding=!0,this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i-this.Width,this.Y+t-(this.Height/2|0),i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)?e=!0:this.Sliding=!1),e?(i<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),0<i&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),t<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.Ya=this.JumpTime=0),0<t&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Character.prototype.IsBlocking=function(i,t,e,s){var h=!1,a=h=0,t=t/16|0;if((i=i/16|0)===(this.X/16|0)&&t===(this.Y/16|0))return!1;if(h=this.World.Level.GetBlock(i,t),0<(Mario.Tile.Behaviors[255&h]&Mario.Tile.PickUpable))for(this.GetCoin(),Enjine.Resources.PlaySound("coin"),this.World.Level.SetBlock(i,t,0),h=0;h<2;h++)for(a=0;a<2;a++)this.World.AddSprite(new Mario.Sparkle(this.World,16*i+8*h+(8*Math.random()|0),16*t+8*a+(8*Math.random()|0),0,0,0,2,5));return(h=this.World.Level.IsBlocking(i,t,e,s))&&s<0&&this.World.Bump(i,t,this.Large),h},Mario.Character.prototype.Stomp=function(i){var t;0<this.DeathTime||this.World.Paused||(t=i.Y-i.Height/2,this.SubMove(0,t-this.Y),i instanceof Mario.Enemy||i instanceof Mario.BulletBill?(Enjine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.Sliding=this.OnGround=!1,this.InvulnerableTime=1):i instanceof Mario.Shell&&(Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)&&0===i.Facing?(this.Carried=i).Carried=!0:(Enjine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.Sliding=this.OnGround=!1,this.InvulnerableTime=1)))},Mario.Character.prototype.GetHurt=function(){0<this.DeathTime||this.World.Paused||0<this.InvulnerableTime||(this.Large?(this.World.Paused=!0,this.PowerUpTime=-18,Enjine.Resources.PlaySound("powerdown"),this.Fire?this.SetLarge(!0,!1):this.SetLarge(!1,!1),this.InvulnerableTime=32):this.Die())},Mario.Character.prototype.Win=function(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.WinTime=1,Enjine.Resources.PlaySound("exit")},Mario.Character.prototype.Die=function(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.DeathTime=1,Enjine.Resources.PlaySound("death"),this.SetLarge(!1,!1)},Mario.Character.prototype.GetFlower=function(){0<this.DeathTime&&this.World.Paused||(this.Fire?(this.GetCoin(),Enjine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Enjine.Resources.PlaySound("powerup"),this.SetLarge(!0,!0)))},Mario.Character.prototype.GetMushroom=function(){0<this.DeathTime&&this.World.Paused||(this.Large?(this.GetCoin(),Enjine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Enjine.Resources.PlaySound("powerup"),this.SetLarge(!0,!1)))},Mario.Character.prototype.Kick=function(i){0<this.DeathTime&&this.World.Paused||(Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)?(this.Carried=i).Carried=!0:(Enjine.Resources.PlaySound("kick"),this.InvulnerableTime=1))},Mario.Character.prototype.Get1Up=function(){Enjine.Resources.PlaySound("1up"),this.Lives++,99===this.Lives&&(this.Lives=99)},Mario.Character.prototype.GetCoin=function(){this.Coins++,100===this.Coins&&(this.Coins=0,this.Get1Up())},Mario.LevelRenderer=function(i,t,e){this.Width=t,this.Height=e,this.Level=i,this.TilesY=1+(e/16|0),this.AnimTime=this.Bounce=this.Tick=this.Delta=0,this.Background=Mario.SpriteCuts.GetLevelSheet()},Mario.LevelRenderer.prototype=new Enjine.Drawable,Mario.LevelRenderer.prototype.Update=function(i){this.AnimTime+=i,this.Tick=0|this.AnimTime,this.Bounce+=30*i,this.Delta=i},Mario.LevelRenderer.prototype.Draw=function(i,t){this.DrawStatic(i,t),this.DrawDynamic(i,t)},Mario.LevelRenderer.prototype.DrawStatic=function(i,t){for(var e,s=0,h=0,a=(t.X+this.Width)/16|0,s=t.X/16|0;s<1+a;s++)for(h=0;h<this.TilesY;h++)e=255&this.Level.GetBlock(s,h),0==(Mario.Tile.Behaviors[e]&Mario.Tile.Animated)&&(e=this.Background[e%16][e/16|0],i.drawImage(Enjine.Resources.Images.map,e.X,e.Y,e.Width,e.Height,(s<<4)-t.X|0,h<<4|0,e.Width,e.Height))},Mario.LevelRenderer.prototype.DrawDynamic=function(i,t){for(var e=0,s=0,h=0,a=0,r=0,h=null,e=t.X/16|0;e<=(t.X+this.Width)/16|0;e++)for(s=t.Y/16|0;s<=(t.Y+this.Height)/16|0;s++)h=this.Level.GetBlock(e,s),0<(Mario.Tile.Behaviors[255&h]&Mario.Tile.Animated)&&(a=(this.Bounce/3|0)%4,0==(h%16/4|0)&&1==(h/16|0)&&(3<(a=(this.Bounce/2+(e+s)/8|0)%20)&&(a=0)),3==(h%16/4|0)&&0==(h/16|0)&&(a=2),(r=0)<=e&&0<=s&&e<this.Level.Width&&s<this.Level.Height&&(r=this.Level.Data[e][s]),0<r&&(r=8*Math.sin((r-this.Delta)/4*Math.PI)|0),h=this.Background[4*(h%16/4|0)+a][h/16|0],i.drawImage(Enjine.Resources.Images.map,h.X,h.Y,h.Width,h.Height,(e<<4)-t.X,(s<<4)-t.Y-r,h.Width,h.Height))},Mario.LevelRenderer.prototype.DrawExit0=function(i,t,e){for(var s=0,s=0,h=null,s=this.Level.ExitY-8;s<this.Level.ExitY;s++)h=this.Background[12][s===this.Level.ExitY-8?4:5],i.drawImage(Enjine.Resources.Images.map,h.X,h.Y,h.Width,h.Height,(this.Level.ExitX<<4)-t.X-16,(s<<4)-t.Y,h.Width,h.Height);e&&(s=16*this.Level.ExitY-48-48*Math.sin(this.AnimTime)-8,h=this.Background[12][3],i.drawImage(Enjine.Resources.Images.map,h.X,h.Y,h.Width,h.Height,(this.Level.ExitX<<4)-t.X-16,s-t.Y,h.Width,h.Height),h=this.Background[13][3],i.drawImage(Enjine.Resources.Images.map,h.X,h.Y,h.Width,h.Height,(this.Level.ExitX<<4)-t.X,s-t.Y,h.Width,h.Height))},Mario.LevelRenderer.prototype.DrawExit1=function(i,t){for(var e,s=0,s=this.Level.ExitY-8;s<this.Level.ExitY;s++)e=this.Background[13][s===this.Level.ExitY-8?4:5],i.drawImage(Enjine.Resources.Images.map,e.X,e.Y,e.Width,e.Height,(this.Level.ExitX<<4)-t.X+16,(s<<4)-t.Y,e.Width,e.Height)},Mario.LevelGenerator=function(i,t){this.Width=i,this.Height=t,this.Odds=[],this.Type=this.Difficulty=this.TotalOdds=0},Mario.LevelGenerator.prototype={CreateLevel:function(i,t){var e=0,s=0,h=e=0,a=0,r=0,o=0,n=null;for(this.Type=i,this.Difficulty=t,this.Odds[Mario.Odds.Straight]=20,this.Odds[Mario.Odds.HillStraight]=10,this.Odds[Mario.Odds.Tubes]=2+t,this.Odds[Mario.Odds.Jump]=2*t,this.Odds[Mario.Odds.Cannon]=5*t-10,this.Type!==Mario.LevelType.Overground&&(this.Odds[Mario.Odds.HillStraight]=0),e=0;e<this.Odds.length;e++)this.Odds[e]<0&&(this.Odds[e]=0),this.TotalOdds+=this.Odds[e],this.Odds[e]=this.TotalOdds-this.Odds[e];for(n=new Mario.Level(this.Width,this.Height),s+=this.BuildStraight(n,0,n.Width,!0);s<n.Width-64;)s+=this.BuildZone(n,s,n.Width-s);for(e=this.Height-1-4*Math.random()|0,n.ExitX=s+8,n.ExitY=e,h=s;h<n.Width;h++)for(a=0;a<this.Height;a++)e<=a&&n.SetBlock(h,a,145);if(i===Mario.LevelType.Castle||i===Mario.LevelType.Underground)for(h=0;h<n.Width;h++)for(o--<=0&&4<h&&(r=4*Math.random()|0,o=4+(4*Math.random()|0)),a=0;a<n.Height;a++)(4<h&&a<=r||h<1)&&n.SetBlock(h,a,145);return this.FixWalls(n),n},BuildZone:function(i,t,e){for(var s=Math.random()*this.TotalOdds|0,h=0,a=0,a=0;a<this.Odds.length;a++)this.Odds[a]<=s&&(h=a);switch(h){case Mario.Odds.Straight:return this.BuildStraight(i,t,e,!1);case Mario.Odds.HillStraight:return this.BuildHillStraight(i,t,e);case Mario.Odds.Tubes:return this.BuildTubes(i,t,e);case Mario.Odds.Jump:return this.BuildJump(i,t,e);case Mario.Odds.Cannons:return this.BuildCannons(i,t,e)}return 0},BuildJump:function(i,t){for(var e=2+(4*Math.random()|0),s=2*e+(2+(2*Math.random()|0)),h=0,a=0,r=0==(3*Math.random()|0),o=this.Height-1-(4*Math.random()|0),h=t;h<t+s;h++)if(h<t+e||t+s-e-1<h)for(a=0;a<this.Height;a++)o<=a?i.SetBlock(h,a,145):r&&(h<t+e?o-(h-t)+1<=a&&i.SetBlock(h,a,9):o-(t+s-h)+2<=a&&i.SetBlock(h,a,9));return s},BuildCannons:function(i,t,e){alert("cannons");var s,h=2+(10*Math.random()|0),a=this.Height-1-4*Math.random()|0,r=t+1+4*Math.random()|0,o=0,n=0;for(e<h&&(h=e),o=t;o<t+h;o++)for(r<o&&(r+=2*Math.random()*4|0),r===t+h-1&&(r+=10),s=a-(4*Math.random()|0)-1,n=0;n<this.Height;n++)a<=n?i.SetBlock(o,n,145):o===r&&s<=n&&(n===s?i.SetBlock(o,n,14):n===1+s?i.SetBlock(o,n,30):i.SetBlock(o,n,46));return h},BuildHillStraight:function(i,t,e){var s,h,a=10+(10*Math.random()|0),r=this.Height-1-4*Math.random()|0,o=0,n=0,l=r,d=!0,c=[],p=0,u=0;for(e<a&&(a=e),o=t;o<t+a;o++)for(n=0;n<this.Height;n++)r<=n&&i.SetBlock(o,n,145);for(this.AddEnemyLine(i,t+1,t+a-1,r-1);d;)if((l=l-2-3*Math.random()|0)<=0)d=!1;else if(s=3+(5*Math.random()|0),c[(h=(Math.random()*(a-s-2)|0)+t+1)-t]||c[h-t+s]||c[h-t-1]||c[h-t+s+1])d=!1;else for(c[h-t]=!0,c[h-t+s]=!0,this.AddEnemyLine(i,h,h+s,l-1),0==(4*Math.random()|0)&&(this.Decorate(i,h-1,h+s+1,l),d=!1),o=h;o<h+s;o++)for(n=l;n<r;n++)p=5,u=9,o===h&&(p=4),o===h+s-1&&(p=6),n===l&&(u=8),0===i.GetBlock(o,n)?i.SetBlock(o,n,p+16*u):(132===i.GetBlock(o,n)&&i.SetBlock(o,n,180),134===i.GetBlock(o,n)&&i.SetBlock(o,n,182));return a},AddEnemyLine:function(i,t,e,s){for(var h=0,a=0,h=t;h<e;h++)(35*Math.random()|0)<this.Difficulty+1&&(a=4*Math.random()|0,this.Difficulty<1?a=Mario.Enemy.Goomba:this.Difficulty<3&&(a=3*Math.random()|0),i.SetSpriteTemplate(h,s,new Mario.SpriteTemplate(a,(35*Math.random()|0)<this.Difficulty)))},BuildTubes:function(i,t,e){var s,h=5+(10*Math.random()|0),a=this.Height-1-4*Math.random()|0,r=t+1+4*Math.random()|0,o=a-(2*Math.random()|0)-2,n=0,l=0;for(e<h&&(h=e),n=t;n<t+h;n++)for(r+1<n&&(r+=3+(4*Math.random()|0),o=a-(2*Math.random()|0)-2),t+h-2<=r&&(r+=10),n===r&&(11*Math.random()|0)<this.Difficulty+1&&i.SetSpriteTemplate(n,o,new Mario.SpriteTemplate(Mario.Enemy.Flower,!1)),l=0;l<this.Height;l++)a<=l?i.SetBlock(n,l,145):(n===r||n===r+1)&&o<=l&&(s=10+n-r,l===o?i.SetBlock(n,l,s):i.SetBlock(n,l,16+s));return h},BuildStraight:function(i,t,e,s){var h=2+(10*Math.random()|0),a=this.Height-1-(4*Math.random()|0),r=0,o=0;for(s&&(h=10+(5*Math.random()|0)),e<h&&(h=e),r=t;r<t+h;r++)for(o=0;o<this.Height;o++)a<=o&&i.SetBlock(r,o,145);return s||5<h&&this.Decorate(i,t,t+h,a),h},Decorate:function(i,t,e,s){if(!(s<1)){var h=4*Math.random()|0,a=4*Math.random()|0,r=0;if(this.AddEnemyLine(i,t+1,e-1,s-1),0<s-2&&1<e-1-a-(t+1+h))for(r=t+1+h;r<e-1-a;r++)i.SetBlock(r,s-2,34);if(h=4*Math.random()|0,a=4*Math.random()|0,0<s-4&&2<e-1-a-(t+1+h))for(r=t+1+h;r<e-1-a;r++)r!==t+1&&r!==e-2&&0==(3*Math.random()|0)?0==(4*Math.random()|0)?i.SetBlock(r,s-4,22):i.SetBlock(r,s-4,21):0==(4*Math.random()|0)?0==(4*Math.random()|0)?i.SetBlock(r,s-4,18):i.SetBlock(r,s-4,17):i.SetBlock(r,s-4,16)}},FixWalls:function(i){for(var t=[],e=0,s=0,h=0,a=0,r=0,e=0;e<this.Width+1;e++)for(t[e]=[],s=0;s<this.Height+1;s++){for(r=0,h=e-1;h<e+1;h++)for(a=s-1;a<s+1;a++)145===i.GetBlockCapped(h,a)&&r++;t[e][s]=4===r}this.Blockify(i,t,this.Width+1,this.Height+1)},Blockify:function(i,t,e,s){for(var h=0,a=[],r=0,o=0,n=0,l=0,d=r=0,c=0,r=0;r<2;r++)a[r]=[];for(this.Type===Mario.LevelType.Castle?h=8:this.Type===Mario.LevelType.Underground&&(h=12),r=0;r<e;r++)for(o=0;o<s;o++){for(n=r;n<=r+1;n++)for(l=o;l<=o+1;l++)(d=n)<0&&(d=0),(c=l)<0&&(c=0),e-1<d&&(d=e-1),s-1<c&&(c=s-1),a[n-r][l-o]=t[d][c];a[0][0]===a[1][0]&&a[0][1]===a[1][1]?a[0][0]===a[0][1]?a[0][0]&&i.SetBlock(r,o,145+h):a[0][0]?i.SetBlock(r,o,161+h):i.SetBlock(r,o,129+h):a[0][0]===a[0][1]&&a[1][0]===a[1][1]?a[0][0]?i.SetBlock(r,o,146+h):i.SetBlock(r,o,144+h):a[0][0]===a[1][1]&&a[0][1]===a[1][0]?i.SetBlock(r,o,145+h):a[0][0]===a[1][0]?a[0][0]?a[0][1]?i.SetBlock(r,o,163+h):i.SetBlock(r,o,179+h):a[0][1]?i.SetBlock(r,o,130+h):i.SetBlock(r,o,128+h):a[0][1]===a[1][1]?a[0][1]?a[0][0]?i.SetBlock(r,o,147+h):i.SetBlock(r,o,131+h):a[0][0]?i.SetBlock(r,o,162+h):i.SetBlock(r,o,160+h):i.SetBlock(r,o,1+16*h)}}},Mario.SpriteTemplate=function(i,t){this.Type=i,this.Winged=t,this.LastVisibleTick=-1,this.IsDead=!1,this.Sprite=null},Mario.SpriteTemplate.prototype={Spawn:function(i,t,e,s){this.IsDead||(this.Sprite=this.Type===Mario.Enemy.Flower?new Mario.FlowerEnemy(i,16*t+15,16*e+24):new Mario.Enemy(i,16*t+8,16*e+15,s,this.Type,this.Winged),this.Sprite.SpriteTemplate=this,i.AddSprite(this.Sprite))}},Mario.Enemy=function(i,t,e,s,h,a){this.AirInertia=this.GroundInertia=.89,this.RunTime=0,this.MayJump=this.OnGround=!1,this.YJumpSpeed=this.XJumpSpeed=this.JumpTime=0,this.Width=4,this.Height=24,this.DeadTime=0,this.FlyDeath=!1,this.WingTime=0,this.NoFireballDeath=!1,this.X=t,this.Y=e,this.World=i,this.Type=h,this.Winged=a,this.Image=Enjine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.AvoidCliffs=this.Type===Mario.Enemy.RedKoopa,this.NoFireballDeath=this.Type===Mario.Enemy.Spiky,this.YPic=this.Type,1<this.YPic&&(this.Height=12),this.Facing=s,0===this.Facing&&(this.Facing=1),this.PicWidth=16},Mario.Enemy.prototype=new Mario.NotchSprite,Mario.Enemy.prototype.CollideCheck=function(){var i,t;0===this.DeadTime&&(i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y,i>2*-this.Width-4&&i<2*this.Width+4&&t>-this.Height&&t<Mario.MarioCharacter.Height&&(!(this.Type!==Mario.Enemy.Spiky&&0<Mario.MarioCharacter.Ya&&t<=0)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Stomp(this),this.Winged?(this.Winged=!1,this.Ya=0):(this.YPicO=7,this.PicHeight=8,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=10,this.Winged=!1,this.Type===Mario.Enemy.RedKoopa?this.World.AddSprite(new Mario.Shell(this.World,this.X,this.Y,0)):this.Type===Mario.Enemy.GreenKoopa&&this.World.AddSprite(new Mario.Shell(this.World,this.X,this.Y,1))))))},Mario.Enemy.prototype.Move=function(){var i=0,i=0;if(this.WingTime++,0<this.DeadTime){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,i=0;i<8;i++)this.World.AddSprite(new Mario.Sparkle(this.World,4+(this.X+16*Math.random()-8|0),4+(this.Y-8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}this.FlyDeath&&(this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1)}else 2<this.Xa&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=1.75*this.Facing,this.MayJump=this.OnGround,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,i=(this.RunTime/20|0)%2,this.OnGround||(i=1),this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=this.Winged?.95:.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround?this.Winged&&(this.Ya=-10):this.Ya+=this.Winged?.6:2,this.Winged&&(i=(this.WingTime/4|0)%2),this.XPic=i},Mario.Enemy.prototype.SubMove=function(i,t){for(var e=!1;8<i;){if(!this.SubMove(8,0))return!1;i-=8}for(;i<-8;){if(!this.SubMove(-8,0))return!1;i+=8}for(;8<t;){if(!this.SubMove(0,8))return!1;t-=8}for(;t<-8;){if(!this.SubMove(0,-8))return!1;t+=8}return 0<t&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)||this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t))&&(e=!0),t<0&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0),0<i&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0),this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking((this.X+this.Xa+this.Width)/16|0,this.Y/16+1|0,this.Xa,1)&&(e=!0)),i<0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0),this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking((this.X+this.Xa-this.Width)/16|0,this.Y/16+1|0,this.Xa,1)&&(e=!0)),e?(i<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),0<i&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),t<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.Ya=this.JumpTime=0),0<t&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Enemy.prototype.IsBlocking=function(i,t,e,s){return t=t/16|0,!((i=i/16|0)===this.X/16|0&&t===this.Y/16|0)&&this.World.Level.IsBlocking(i,t,e,s)},Mario.Enemy.prototype.ShellCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return-16<t&&t<16&&e>-this.Height&&e<i.Height&&(Enjine.Resources.PlaySound("kick"),this.Xa=2*i.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0)},Mario.Enemy.prototype.FireballCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return-16<t&&t<16&&e>-this.Height&&e<i.Height?!!this.NoFireballDeath||(Enjine.Resources.PlaySound("kick"),this.Xa=2*i.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0):void 0},Mario.Enemy.prototype.BumpCheck=function(i,t){0===this.DeadTime&&this.X+this.Width>16*i&&this.X-this.Width<16*i+16&&t===(this.Y-1)/16|0&&(Enjine.Resources.PlaySound("kick"),this.Xa=2*-Mario.MarioCharacter.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0)},Mario.Enemy.prototype.SubDraw=Mario.NotchSprite.prototype.Draw,Mario.Enemy.prototype.Draw=function(i,t){var e=0,s=0;this.Winged&&(e=(this.XOld+(this.X-this.XOld)*this.Delta|0)-this.XPicO,s=(this.YOld+(this.Y-this.YOld)*this.Delta|0)-this.YPicO,this.Type!==Mario.Enemy.RedKoopa&&this.Type!==Mario.Enemy.GreenKoopa)&&(this.XFlip=!this.XFlip,i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,(this.WingTime/4|0)%2*16,128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s-32:s-8,16,32),i.restore(),this.XFlip=!this.XFlip),this.SubDraw(i,t),this.Winged&&(e=(this.XOld+(this.X-this.XOld)*this.Delta|0)-this.XPicO,s=(this.YOld+(this.Y-this.YOld)*this.Delta|0)-this.YPicO,this.Type===Mario.Enemy.RedKoopa&&this.Type===Mario.Enemy.GreenKoopa?(i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,(this.WingTime/4|0)%2*16,128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s:s-8,16,32)):(i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,(this.WingTime/4|0)%2*16,128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s-32:s-8,16,32)),i.restore())},Mario.Enemy.RedKoopa=0,Mario.Enemy.GreenKoopa=1,Mario.Enemy.Goomba=2,Mario.Enemy.Spiky=3,Mario.Enemy.Flower=4,Mario.Fireball=function(i,t,e,s){this.AirInertia=this.GroundInertia=.89,this.Image=Enjine.Resources.Images.particles,this.World=i,this.X=t,this.Y=e,this.Facing=s,this.YPicO=this.XPicO=4,this.YPic=3,this.XPic=4,this.Height=8,this.Width=4,this.PicWidth=this.PicHeight=8,this.Ya=4,this.Dead=!1,this.Anim=this.DeadTime=0,this.OnGround=!1},Mario.Fireball.prototype=new Mario.NotchSprite,Mario.Fireball.prototype.Move=function(){var i=0;if(0<this.DeadTime){for(i=0;i<8;i++)this.World.AddSprite(new Mario.Sparkle(this.World,4+(this.X+8*Math.random()-4|0),2+(this.Y+8*Math.random()-4|0),2*Math.random()-this.Facing,2*Math.random()-1,0,1,5));this.World.RemoveSprite(this)}else 0!=this.Facing&&this.Anim++,2<this.Xa&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=8*this.Facing,this.World.CheckFireballCollide(this),this.FlipX=-1===this.Facing,this.XPic=this.Anim%4,this.SubMove(this.Xa,0)||this.Die(),this.OnGround=!1,this.SubMove(0,this.Ya),this.OnGround&&(this.Ya=-10),this.Ya*=.95,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=1.5)},Mario.Fireball.prototype.SubMove=function(i,t){for(var e=!1;8<i;){if(!this.SubMove(8,0))return!1;i-=8}for(;i<-8;){if(!this.SubMove(-8,0))return!1;i+=8}for(;8<t;){if(!this.SubMove(0,8))return!1;t-=8}for(;t<-8;){if(!this.SubMove(0,-8))return!1;t+=8}return 0<t&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)||this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t))&&(e=!0),t<0&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0),0<i&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0)),i<0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0)),e?(i<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),0<i&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),t<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.Ya=0),0<t&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Fireball.prototype.IsBlocking=function(i,t,e,s){return t=t/16|0,!((i=i/16|0)===this.X/16|0&&t===this.Y/16|0)&&this.World.Level.IsBlocking(i,t,e,s)},Mario.Fireball.prototype.Die=function(){this.Dead=!0,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100},Mario.Sparkle=function(i,t,e,s,h){this.World=i,this.X=t,this.Y=e,this.Xa=s,this.Ya=h,this.XPic=2*Math.random()|0,this.YPic=0,this.Life=10+(5*Math.random()|0),this.XPicStart=this.XPic,this.YPicO=this.XPicO=4,this.PicHeight=this.PicWidth=8,this.Image=Enjine.Resources.Images.particles},Mario.Sparkle.prototype=new Mario.NotchSprite,Mario.Sparkle.prototype.Move=function(){this.XPic=10<this.Life?7:this.XPicStart+.4*(10-this.Life)|0,this.Life--<0&&this.World.RemoveSprite(this),this.X+=this.Xa,this.Y+=this.Ya},Mario.CoinAnim=function(i,t,e){this.World=i,this.Life=10,this.Image=Enjine.Resources.Images.map,this.PicWidth=this.PicHeight=16,this.X=16*t,this.Y=16*e-16,this.Xa=0,this.Ya=-6,this.XPic=0,this.YPic=2},Mario.CoinAnim.prototype=new Mario.NotchSprite,Mario.CoinAnim.prototype.Move=function(){var i=0,t=0;if(this.Life--<0)for(this.World.RemoveSprite(this),i=0;i<2;i++)for(t=0;t<2;t++)this.World.AddSprite(new Mario.Sparkle(this.World,this.X+8*i+8*Math.random()|0,this.Y+8*t+8*Math.random()|0,0,0,0,2,5));this.XPic=3&this.Life,this.X+=this.Xa,this.Y+=this.Ya,this.Ya+=1},Mario.Mushroom=function(i,t,e){this.RunTime=0,this.AirInertia=this.GroundInertia=.89,this.OnGround=!1,this.Width=4,this.Height=24,this.World=i,this.X=t,this.Y=e,this.Image=Enjine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0},Mario.Mushroom.prototype=new Mario.NotchSprite,Mario.Mushroom.prototype.CollideCheck=function(){var i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y;-16<i&&i<16&&t>-this.Height&&t<Mario.MarioCharacter.Height&&(Mario.MarioCharacter.GetMushroom(),this.World.RemoveSprite(this))},Mario.Mushroom.prototype.Move=function(){this.Life<9?(this.Layer=0,this.Y--,this.Life++):(this.Layer=1,2<this.Xa&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=1.75*this.Facing,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=2))},Mario.Mushroom.prototype.SubMove=function(i,t){for(var e=!1;8<i;){if(!this.SubMove(8,0))return!1;i-=8}for(;i<-8;){if(!this.SubMove(-8,0))return!1;i+=8}for(;8<t;){if(!this.SubMove(0,8))return!1;t-=8}for(;t<-8;){if(!this.SubMove(0,-8))return!1;t+=8}return 0<t&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)||this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t))&&(e=!0),t<0&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0),0<i&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0)),i<0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0)),e?(i<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),0<i&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),t<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.Ya=this.JumpTime=0),0<t&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Mushroom.prototype.IsBlocking=function(i,t,e,s){return t=t/16|0,!((i=i/16|0)===this.X/16|0&&t===this.Y/16|0)&&this.World.Level.IsBlocking(i,t,e,s)},Mario.Mushroom.prototype.BumpCheck=function(i,t){this.X+this.Width>16*i&&this.X-this.Width<16*i-16&&t===(t-1)/16|0&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)},Mario.Particle=function(i,t,e,s,h){this.World=i,this.X=t,this.Y=e,this.Xa=s,this.Ya=h,this.XPic=2*Math.random()|0,this.YPic=0,this.YPicO=this.XPicO=4,this.PicHeight=this.PicWidth=8,this.Life=10,this.Image=Enjine.Resources.Images.particles},Mario.Particle.prototype=new Mario.NotchSprite,Mario.Particle.prototype.Move=function(){this.Life-this.Delta<0&&this.World.RemoveSprite(this),this.Life-=this.Delta,this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=3},Mario.FireFlower=function(i,t,e){this.Width=4,this.Height=24,this.World=i,this.X=t,this.Y=e,this.Image=Enjine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.XPic=1,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0},Mario.FireFlower.prototype=new Mario.NotchSprite,Mario.FireFlower.prototype.CollideCheck=function(){var i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y;-16<i&&i<16&&t>-this.Height&&t<Mario.MarioCharacter.Height&&(Mario.MarioCharacter.GetFlower(),this.World.RemoveSprite(this))},Mario.FireFlower.prototype.Move=function(){this.Life<9&&(this.Layer=0,this.Y--,this.Life++)},Mario.BulletBill=function(i,t,e,s){this.Image=Enjine.Resources.Images.enemies,this.World=i,this.X=t,this.Y=e,this.Facing=s,this.XPicO=8,this.YPicO=31,this.Height=12,this.Width=4,this.PicWidth=16,this.YPic=5,this.XPic=0,this.Ya=-5,this.DeadTime=0,this.Dead=!1,this.Anim=0},Mario.BulletBill.prototype=new Mario.NotchSprite,Mario.BulletBill.prototype.CollideCheck=function(){var i,t;this.Dead||(i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y,-16<i&&i<16&&t>-this.Height&&t<this.World.Mario.Height&&(!(0<Mario.MarioCharacter.Y&&t<=0)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Stomp(this),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100)))},Mario.BulletBill.prototype.Move=function(){var i=0;if(0<this.DeadTime){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,i=0;i<8;i++)this.World.AddSprite(new Mario.Sparkle(4+(this.X+16*Math.random()-8|0),4+(this.Y+8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1}else this.Xa=4*this.Facing,this.XFlip=-1===this.Facing,this.Move(this.Xa,0)},Mario.BulletBill.prototype.SubMove=function(i){return this.X+=i,!0},Mario.BulletBill.prototype.FireballCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return-16<t&&t<16&&e>-this.Height&&e<i.Height},Mario.BulletBill.prototype.ShellCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return-16<t&&t<16&&e>-this.Height&&e<i.Height&&(Enjine.Resources.PlaySound("kick"),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100,!0)},Mario.FlowerEnemy=function(i,t,e){for(this.Image=Enjine.Resources.Images.enemies,this.World=i,this.X=t,this.Y=e,this.Facing=1,this.Type=Mario.Enemy.Spiky,this.NoFireballDeath=this.Winged=!1,this.XPic=0,this.YPic=6,this.YPicO=24,this.Height=12,this.Width=2,this.YStart=e,this.Ya=-8,--this.Y,i=this.Tick=this.JumpTime=this.Layer=0;i<4;i++)this.Move()},Mario.FlowerEnemy.prototype=new Mario.Enemy,Mario.FlowerEnemy.prototype.Move=function(){var i=0,i=0;if(0<this.DeadTime){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,i=0;i<8;i++)this.World.AddSprite(new Mario.Sparkle(4+(this.X+16*Math.random()-8|0),4+(this.Y+8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1}else this.Tick++,this.Y>=this.YStart?(this.YStart=this.Y,i=0|Math.abs(Mario.MarioCharacter.X-this.X),this.JumpTime++,this.Ya=40<this.JumpTime&&24<i?-8:0):this.JumpTime=0,this.Y+=this.Ya,this.Ya*=.9,this.Ya+=.1,this.XPic=2*(1&(this.Tick/2|0))+(1&(this.Tick/6|0))},Mario.Shell=function(i,t,e,s){this.World=i,this.X=t,this.Y=e,this.YPic=s,this.Image=Enjine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.Width=4,this.Height=12,this.Facing=0,this.PicWidth=16,this.XPic=4,this.Ya=-5,this.Dead=!1,this.DeadTime=0,this.Carried=!1,this.AirInertia=this.GroundInertia=.89,this.OnGround=!1,this.Anim=0},Mario.Shell.prototype=new Mario.NotchSprite,Mario.Shell.prototype.FireballCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return-16<t&&t<16&&e>-this.Height&&e<i.Height&&(0!==this.Facing||(Enjine.Resources.PlaySound("kick"),this.Xa=2*i.Facing,this.Ya=-5,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.YFlip=!0))},Mario.Shell.prototype.CollideCheck=function(){var i,t;this.Carried||this.Dead||0<this.DeadTime||(i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y,-16<i&&i<16&&t>-this.Height&&t<Mario.MarioCharacter.Height&&(!(0<Mario.MarioCharacter.Ya&&t<=0)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?0!==this.Facing?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Kick(this),this.Facing=Mario.MarioCharacter.Facing):(Mario.MarioCharacter.Stomp(this),this.Facing=0!==this.Facing?this.Xa=0:Mario.MarioCharacter.Facing)))},Mario.Shell.prototype.Move=function(){var i=0;if(this.Carried)this.World.CheckShellCollide(this);else if(0<this.DeadTime){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,i=0;i<8;i++)this.World.AddSprite(new Mario.Sparkle(4+(this.X+16*Math.random()-8|0),4+(this.Y+8*Math.random()|0),2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1}else 0!==this.Facing&&this.Anim++,2<this.Xa&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=11*this.Facing,0!==this.Facing&&this.World.CheckShellCollide(this),this.XFlip=-1===this.Facing,this.XPic=(this.Anim/2|0)%4+3,this.SubMove(this.Xa,0)||(Enjine.Resources.PlaySound("bump"),this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=2)},Mario.Shell.prototype.SubMove=function(i,t){for(var e=!1;8<i;){if(!this.SubMove(8,0))return!1;i-=8}for(;i<-8;){if(!this.SubMove(-8,0))return!1;i+=8}for(;8<t;){if(!this.SubMove(0,8))return!1;t-=8}for(;t<-8;){if(!this.SubMove(0,-8))return!1;t+=8}return 0<t&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)||this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)||this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t))&&(e=!0),t<0&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)||e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0),0<i&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0)),i<0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(this.Height/2|0),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0)),e?(i<0&&(this.X=16*((this.X-this.Width)/16|0)+this.Width,this.Xa=0),0<i&&(this.X=16*((this.X+this.Width)/16+1|0)-this.Width-1,this.Xa=0),t<0&&(this.Y=16*((this.Y-this.Height)/16|0)+this.Height,this.Ya=0),0<t&&(this.Y=16*((this.Y-1)/16+1|0)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Shell.prototype.IsBlocking=function(i,t,e,s){if(t=t/16|0,(i=i/16|0)===(this.X/16|0)&&t===(this.Y/16|0))return!1;var h=this.World.Level.IsBlocking(i,t,e,s);return h&&0===s&&0!==e&&this.World.Bump(i,t,!0),h},Mario.Shell.prototype.BumpCheck=function(i,t){this.X+this.Width>16*i&&this.X-this.Width<16*i+16&&t===((this.Y-1)/16|0)&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)},Mario.Shell.prototype.Die=function(){this.Dead=!0,this.Carried=!1,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100},Mario.Shell.prototype.ShellCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return-16<t&&t<16&&e>-this.Height&&e<i.Height&&(Enjine.Resources.PlaySound("kick"),Mario.MarioCharacter.Carried!==i&&Mario.MarioCharacter.Carried!==this||(Mario.MarioCharacter.Carried=null),this.Die(),i.Die(),!0)},Mario.Shell.prototype.Release=function(){this.Carried=!1,this.Facing=Mario.MarioCharacter.Facing,this.X+=8*this.Facing},Mario.TitleState=function(){this.font=this.bounce=this.logoY=this.camera=this.drawManager=null},Mario.TitleState.prototype=new Enjine.GameState,Mario.TitleState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera;var i=new Mario.BackgroundGenerator(2048,15,!0,Mario.LevelType.Overground),t=new Mario.BackgroundRenderer(i.CreateLevel(),320,240,2);i.SetValues(2048,15,!1,Mario.LevelType.Overground),i=new Mario.BackgroundRenderer(i.CreateLevel(),320,240,1),this.title=new Enjine.Sprite,this.title.Image=Enjine.Resources.Images.title,this.title.X=0,this.title.Y=120,this.logo=new Enjine.Sprite,this.logo.Image=Enjine.Resources.Images.logo,this.logo.X=0,this.logo.Y=0,this.font=Mario.SpriteCuts.CreateRedFont(),this.font.Strings[0]={String:"Press S to Start",X:96,Y:120},this.logoY=20,this.drawManager.Add(t),this.drawManager.Add(i),this.bounce=0,Mario.GlobalMapState=new Mario.MapState,Mario.MarioCharacter=new Mario.Character,Mario.MarioCharacter.Image=Enjine.Resources.Images.smallMario},Mario.TitleState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.font},Mario.TitleState.prototype.Update=function(i){this.bounce+=2*i,this.logoY=20+10*Math.sin(this.bounce),this.camera.X+=25*i,this.drawManager.Update(i)},Mario.TitleState.prototype.Draw=function(i){this.drawManager.Draw(i,this.camera),i.drawImage(Enjine.Resources.Images.title,0,120),i.drawImage(Enjine.Resources.Images.logo,0,this.logoY),this.font.Draw(i,this.Camera)},Mario.TitleState.prototype.CheckForChange=function(i){Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&i.ChangeState(Mario.GlobalMapState)},Mario.LoadingState=function(){this.Images=[],this.ImagesLoaded=!1,this.ScreenColor=0,this.ColorDirection=1,this.SoundIndex=this.ImageIndex=0},Mario.LoadingState.prototype=new Enjine.GameState,Mario.LoadingState.prototype.Enter=function(){for(var i=0,i=0;i<15;i++)this.Images[i]={};this.Images[0].name="background",this.Images[1].name="endScene",this.Images[2].name="enemies",this.Images[3].name="fireMario",this.Images[4].name="font",this.Images[5].name="gameOverGhost",this.Images[6].name="items",this.Images[7].name="logo",this.Images[8].name="map",this.Images[9].name="mario",this.Images[10].name="particles",this.Images[11].name="racoonMario",this.Images[12].name="smallMario",this.Images[13].name="title",this.Images[14].name="worldMap",this.Images[0].src="images/bgsheet.png",this.Images[1].src="images/endscene.gif",this.Images[2].src="images/enemysheet.png",this.Images[3].src="images/firemariosheet.png",this.Images[4].src="images/font.gif",this.Images[5].src="images/gameovergost.gif",this.Images[6].src="images/itemsheet.png",this.Images[7].src="images/logo.gif",this.Images[8].src="images/mapsheet.png",this.Images[9].src="images/mariosheet.png",this.Images[10].src="images/particlesheet.png",this.Images[11].src="images/racoonmariosheet.png",this.Images[12].src="images/smallmariosheet.png",this.Images[13].src="images/title.gif",this.Images[14].src="images/worldmap.png",Enjine.Resources.AddImages(this.Images),(new Audio).canPlayType("audio/mp3")?Enjine.Resources.AddSound("1up","sounds/1-up.mp3",1).AddSound("breakblock","sounds/breakblock.mp3").AddSound("bump","sounds/bump.mp3",4).AddSound("cannon","sounds/cannon.mp3").AddSound("coin","sounds/coin.mp3",5).AddSound("death","sounds/death.mp3",1).AddSound("exit","sounds/exit.mp3",1).AddSound("fireball","sounds/fireball.mp3",1).AddSound("jump","sounds/jump.mp3").AddSound("kick","sounds/kick.mp3").AddSound("pipe","sounds/pipe.mp3",1).AddSound("powerdown","sounds/powerdown.mp3",1).AddSound("powerup","sounds/powerup.mp3",1).AddSound("sprout","sounds/sprout.mp3",1).AddSound("stagestart","sounds/stagestart.mp3",1).AddSound("stomp","sounds/stomp.mp3",2):Enjine.Resources.AddSound("1up","sounds/1-up.wav",1).AddSound("breakblock","sounds/breakblock.wav").AddSound("bump","sounds/bump.wav",2).AddSound("cannon","sounds/cannon.wav").AddSound("coin","sounds/coin.wav",5).AddSound("death","sounds/death.wav",1).AddSound("exit","sounds/exit.wav",1).AddSound("fireball","sounds/fireball.wav",1).AddSound("jump","sounds/jump.wav",1).AddSound("kick","sounds/kick.wav",1).AddSound("message","sounds/message.wav",1).AddSound("pipe","sounds/pipe.wav",1).AddSound("powerdown","sounds/powerdown.wav",1).AddSound("powerup","sounds/powerup.wav",1).AddSound("sprout","sounds/sprout.wav",1).AddSound("stagestart","sounds/stagestart.wav",1).AddSound("stomp","sounds/stomp.wav",1),Mario.Tile.LoadBehaviors()},Mario.LoadingState.prototype.Exit=function(){delete this.Images},Mario.LoadingState.prototype.Update=function(i){if(!this.ImagesLoaded){this.ImagesLoaded=!0;for(var t=0,t=0;t<this.Images.length;t++)if(!0!==Enjine.Resources.Images[this.Images[t].name].complete){this.ImagesLoaded=!1;break}}this.ScreenColor+=255*this.ColorDirection*i,255<this.ScreenColor?(this.ScreenColor=255,this.ColorDirection=-1):this.ScreenColor<0&&(this.ScreenColor=0,this.ColorDirection=1)},Mario.LoadingState.prototype.Draw=function(i){var t;this.ImagesLoaded?i.fillStyle="rgb(0, 0, 0)":(t=parseInt(this.ScreenColor,10),i.fillStyle="rgb("+t+","+t+","+t+")"),i.fillRect(0,0,640,480)},Mario.LoadingState.prototype.CheckForChange=function(i){this.ImagesLoaded&&(Mario.GlobalMapState=new Mario.MapState,i.ChangeState(new Mario.TitleState))},Mario.LoseState=function(){this.font=this.gameOver=this.camera=this.drawManager=null,this.wasKeyDown=!1},Mario.LoseState.prototype=new Enjine.GameState,Mario.LoseState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera,this.gameOver=new Enjine.AnimatedSprite,this.gameOver.Image=Enjine.Resources.Images.gameOverGhost,this.gameOver.SetColumnCount(9),this.gameOver.SetRowCount(1),this.gameOver.AddNewSequence("turnLoop",0,0,0,8),this.gameOver.PlaySequence("turnLoop",!0),this.gameOver.FramesPerSecond=1/15,this.gameOver.X=112,this.gameOver.Y=68,this.font=Mario.SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Game over!",X:116,Y:160},this.drawManager.Add(this.font),this.drawManager.Add(this.gameOver)},Mario.LoseState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.gameOver,delete this.font},Mario.LoseState.prototype.Update=function(i){this.drawManager.Update(i),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&(this.wasKeyDown=!0)},Mario.LoseState.prototype.Draw=function(i){this.drawManager.Draw(i,this.camera)},Mario.LoseState.prototype.CheckForChange=function(i){this.wasKeyDown&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&i.ChangeState(new Mario.TitleState)},Mario.WinState=function(){this.waitTime=2,this.kissing=this.font=this.camera=this.drawManager=null,this.wasKeyDown=!1},Mario.WinState.prototype=new Enjine.GameState,Mario.WinState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera,this.font=Mario.SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Thank you for saving me, Mario!",X:36,Y:160},this.kissing=new Enjine.AnimatedSprite,this.kissing.Image=Enjine.Resources.Images.endScene,this.kissing.X=112,this.kissing.Y=52,this.kissing.SetColumnCount(2),this.kissing.SetRowCount(1),this.kissing.AddNewSequence("loop",0,0,0,1),this.kissing.PlaySequence("loop",!0),this.kissing.FramesPerSecond=.5,this.waitTime=2,this.drawManager.Add(this.font),this.drawManager.Add(this.kissing)},Mario.WinState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera},Mario.WinState.prototype.Update=function(i){this.drawManager.Update(i),0<this.waitTime?this.waitTime-=i:Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&(this.wasKeyDown=!0)},Mario.WinState.prototype.Draw=function(i){this.drawManager.Draw(i,this.camera)},Mario.WinState.prototype.CheckForChange=function(i){this.waitTime<=0&&this.wasKeyDown&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&i.ChangeState(new Mario.TitleState)},Mario.MapTile={Grass:0,Water:1,Level:2,Road:3,Decoration:4},Mario.MapState=function(){this.camera=new Enjine.Camera,this.Level=[],this.Data=[],this.YFarthestCap=this.XFarthestCap=this.Farthest=this.LevelId=this.MoveTime=this.YMarioA=this.XMarioA=this.YMario=this.XMario=0,this.MapImage=document.createElement("canvas"),this.MapImage.width=320,this.MapImage.height=240,this.MapContext=this.MapImage.getContext("2d"),this.EnterLevel=this.CanEnterLevel=!1,this.LevelType=this.LevelDifficulty=0,this.WorldNumber=-1,this.NextWorld()},Mario.MapState.prototype=new Enjine.GameState,Mario.MapState.prototype.Enter=function(){this.WaterSprite=new Enjine.AnimatedSprite,this.WaterSprite.Image=Enjine.Resources.Images.worldMap,this.WaterSprite.SetColumnCount(16),this.WaterSprite.SetRowCount(16),this.WaterSprite.AddNewSequence("loop",14,0,14,3),this.WaterSprite.FramesPerSecond=1/3,this.WaterSprite.PlaySequence("loop",!0),this.WaterSprite.X=0,this.WaterSprite.Y=0,this.DecoSprite=new Enjine.AnimatedSprite,this.DecoSprite.Image=Enjine.Resources.Images.worldMap,this.DecoSprite.SetColumnCount(16),this.DecoSprite.SetRowCount(16),this.DecoSprite.AddNewSequence("world0",10,0,10,3),this.DecoSprite.AddNewSequence("world1",11,0,11,3),this.DecoSprite.AddNewSequence("world2",12,0,12,3),this.DecoSprite.AddNewSequence("world3",13,0,13,3),this.DecoSprite.FramesPerSecond=1/3,this.DecoSprite.PlaySequence("world0",!0),this.DecoSprite.X=0,this.DecoSprite.Y=0,this.HelpSprite=new Enjine.AnimatedSprite,this.HelpSprite.Image=Enjine.Resources.Images.worldMap,this.HelpSprite.SetColumnCount(16),this.HelpSprite.SetRowCount(16),this.HelpSprite.AddNewSequence("help",7,3,7,5),this.HelpSprite.FramesPerSecond=.5,this.HelpSprite.PlaySequence("help",!0),this.HelpSprite.X=0,this.HelpSprite.Y=0,this.SmallMario=new Enjine.AnimatedSprite,this.SmallMario.Image=Enjine.Resources.Images.worldMap,this.SmallMario.SetColumnCount(16),this.SmallMario.SetRowCount(16),this.SmallMario.AddNewSequence("small",1,0,1,1),this.SmallMario.FramesPerSecond=1/3,this.SmallMario.PlaySequence("small",!0),this.SmallMario.X=0,this.SmallMario.Y=0,this.LargeMario=new Enjine.AnimatedSprite,this.LargeMario.Image=Enjine.Resources.Images.worldMap,this.LargeMario.SetColumnCount(16),this.LargeMario.SetRowCount(8),this.LargeMario.AddNewSequence("large",0,2,0,3),this.LargeMario.AddNewSequence("fire",0,4,0,5),this.LargeMario.FramesPerSecond=1/3,this.LargeMario.PlaySequence("large",!0),this.LargeMario.X=0,this.LargeMario.Y=0,this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),this.DecoSprite.PlaySequence("world"+this.WorldNumber%4,!0),Mario.MarioCharacter.Fire?this.LargeMario.PlaySequence("fire",!0):this.LargeMario.PlaySequence("large",!0),this.EnterLevel=!1,this.LevelType=this.LevelDifficulty=0},Mario.MapState.prototype.Exit=function(){delete this.WaterSprite,delete this.DecoSprite,delete this.HelpSprite,delete this.SmallMario,delete this.LargeMario,delete this.FontShadow,delete this.Font},Mario.MapState.prototype.NextWorld=function(){var i=!1;if(this.WorldNumber++,8!==this.WorldNumber){for(this.YFarthestCap=this.XFarthestCap=this.Farthest=this.LevelId=this.MoveTime=0;!i;)i=this.GenerateLevel();this.RenderStatic()}},Mario.MapState.prototype.GenerateLevel=function(){var i=0,t=0,e=0,e=0,s=new Mario.ImprovedNoise(0x7ffffffffffffc00*Math.random()|0),h=new Mario.ImprovedNoise(0x7ffffffffffffc00*Math.random()|0),a=new Mario.ImprovedNoise(0x7ffffffffffffc00*Math.random()|0);this.Level=[],this.Data=[];for(var r=512*Math.random(),o=512*Math.random(),n=512*Math.random(),l=512*Math.random(),i=0;i<21;i++)for(this.Level[i]=[],this.Data[i]=[],t=0;t<16;t++)e=s.PerlinNoise(10*i+r,10*t+o),e-=h.PerlinNoise(10*i+n,10*t+l),e*=2,this.Level[i][t]=0<e?Mario.MapTile.Water:Mario.MapTile.Grass;for(h=s=9999,n=e=0;n<100&&e<12;n++)i=3*(6*Math.random()|0)+2,t=3*(5*Math.random()|0)+1,this.Level[i][t]===Mario.MapTile.Grass&&(i<s&&(s=i,h=t),this.Level[i][t]=Mario.MapTile.Level,this.Data[i][t]=-1,e++);for(this.Data[s][h]=-2,i=!0;i;)i=this.FindConnection(21,16);if(this.FindCaps(21,16),0===this.XFarthestCap)return!1;for(this.Data[this.XFarthestCap][this.YFarthestCap]=-2,this.Data[this.XMario/16|0][this.YMario/16|0]=-11,i=0;i<21;i++)for(t=0;t<16;t++)this.Level[i][t]!==Mario.MapTile.Grass||i===this.XFarthestCap&&t===this.YFarthestCap-1||0<(e=a.PerlinNoise(10*i+r,10*t+o))&&(this.Level[i][t]=Mario.MapTile.Decoration);return!0},Mario.MapState.prototype.FindConnection=function(i,t){for(var e=0,s=0,e=0;e<i;e++)for(s=0;s<t;s++)if(this.Level[e][s]===Mario.MapTile.Level&&-1===this.Data[e][s])return this.Connect(e,s,i,t),!0;return!1},Mario.MapState.prototype.Connect=function(i,t,e,s){for(var h,a,r=1e4,o=0,n=0,l=0,d=0,l=0;l<e;l++)for(d=0;d<s;d++)this.Level[l][d]===Mario.MapTile.Level&&-2===this.Data[l][d]&&((h=(h=0|Math.abs(i-l))*h+(a=0|Math.abs(t-d))*a)<r&&(o=l,n=d,r=h));this.DrawRoad(i,t,o,n),this.Level[i][t]=Mario.MapTile.Level,this.Data[i][t]=-2},Mario.MapState.prototype.DrawRoad=function(i,t,e,s){var h=!1;if(.5<Math.random()&&(h=!0),h){for(;e<i;)this.Data[i][t]=0,this.Level[i--][t]=Mario.MapTile.Road;for(;i<e;)this.Data[i][t]=0,this.Level[i++][t]=Mario.MapTile.Road}for(;s<t;)this.Data[i][t]=0,this.Level[i][t--]=Mario.MapTile.Road;for(;t<s;)this.Data[i][t]=0,this.Level[i][t++]=Mario.MapTile.Road;if(!h){for(;e<i;)this.Data[i][t]=0,this.Level[i--][t]=Mario.MapTile.Road;for(;i<e;)this.Data[i][t]=0,this.Level[i++][t]=Mario.MapTile.Road}},Mario.MapState.prototype.FindCaps=function(i,t){for(var e=0,s=0,h=-1,a=-1,r=0,o=0,n=0,e=0;e<i;e++)for(s=0;s<t;s++)if(this.Level[e][s]===Mario.MapTile.Level){for(r=0,o=e-1;o<=e+1;o++)for(n=s-1;n<=s+1;n++)this.Level[o][n]===Mario.MapTile.Road&&r++;1===r?(-1===h&&(h=e,a=s),this.Data[e][s]=0):this.Data[e][s]=1}this.XMario=16*h,this.YMario=16*a,this.Travel(h,a,-1,0)},Mario.MapState.prototype.Travel=function(i,t,e,s){if(this.Level[i][t]===Mario.MapTile.Road||this.Level[i][t]===Mario.MapTile.Level){if(this.Level[i][t]===Mario.MapTile.Road){if(1===this.Data[i][t])return;this.Data[i][t]=1}this.Level[i][t]===Mario.MapTile.Level&&(0<this.Data[i][t]?this.Data[i][t]=0!==this.LevelId&&0==(4*Math.random()|0)?-3:++this.LevelId:0<s&&(this.Data[i][t]=-1,s>this.Farthest)&&(this.Farthest=s,this.XFarthestCap=i,this.YFarthestCap=t)),2!==e&&this.Travel(i-1,t,0,s++),3!==e&&this.Travel(i,t-1,1,s++),0!==e&&this.Travel(i+1,t,2,s++),1!==e&&this.Travel(i,t+1,3,s++)}},Mario.MapState.prototype.RenderStatic=function(){for(var i=0,t=0,e=0,s=e=0,h=0,a=Enjine.Resources.Images.worldMap,i=s=0;i<20;i++)for(t=0;t<15;t++)if(this.MapContext.drawImage(a,16*(this.WorldNumber/4|0),0,16,16,16*i,16*t,16,16),this.Level[i][t]===Mario.MapTile.Level)0===(s=this.Data[i][t])?this.MapContext.drawImage(a,0,112,16,16,16*i,16*t,16,16):-1===s?this.MapContext.drawImage(a,48,128,16,16,16*i,16*t,16,16):-3===s?this.MapContext.drawImage(a,0,128,16,16,16*i,16*t,16,16):-10===s?this.MapContext.drawImage(a,16,128,16,16,16*i,16*t,16,16):-11===s?this.MapContext.drawImage(a,16,112,16,16,16*i,16*t,16,16):-2===s?(this.MapContext.drawImage(a,32,112,16,16,16*i,16*(t-1),16,16),this.MapContext.drawImage(a,32,128,16,16,16*i,16*t,16,16)):this.MapContext.drawImage(a,16*(s-1),96,16,16,16*i,16*t,16,16);else if(this.Level[i][t]===Mario.MapTile.Road)e=(e=this.IsRoad(i-1,t)?1:0)+2*(this.IsRoad(i,t-1)?1:0)+4*(this.IsRoad(i+1,t)?1:0)+8*(this.IsRoad(i,t+1)?1:0),this.MapContext.drawImage(a,16*e,32,16,16,16*i,16*t,16,16);else if(this.Level[i][t]===Mario.MapTile.Water)for(s=0;s<2;s++)for(h=0;h<2;h++)0<=(e=(e=this.IsWater(2*i+(s-1),2*t+(h-1))?0:1)+2*(this.IsWater(2*i+s,2*t+(h-1))?0:1)+4*(this.IsWater(2*i+(s-1),2*t+h)?0:1)+8*(this.IsWater(2*i+s,2*t+h)?0:1)-1)&&e<=14&&this.MapContext.drawImage(a,16*e,16*(4+(s+h&1)),16,16,16*i+8*s,16*t+8*h,16,16)},Mario.MapState.prototype.IsRoad=function(i,t){return i<0&&(i=0),t<0&&(t=0),this.Level[i][t]===Mario.MapTile.Road||this.Level[i][t]===Mario.MapTile.Level},Mario.MapState.prototype.IsWater=function(i,t){var e=0,s=0;for(i<0&&(i=0),t<0&&(t=0),e=0;e<2;e++)for(s=0;s<2;s++)if(this.Level[(i+e)/2|0][(t+s)/2|0]!==Mario.MapTile.Water)return!1;return!0},Mario.MapState.prototype.Update=function(i){var t,e,s=0,h=0;8!==this.WorldNumber&&(this.XMario+=this.XMarioA,this.YMario+=this.YMarioA,t=this.XMario/16|0,e=this.YMario/16|0,this.Level[t][e]===Mario.MapTile.Road&&(this.Data[t][e]=0),0<this.MoveTime?this.MoveTime--:(this.YMarioA=this.XMarioA=0,this.CanEnterLevel&&Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&this.Level[t][e]===Mario.MapTile.Level&&-11!==this.Data[t][e]&&this.Level[t][e]===Mario.MapTile.Level&&0!==this.Data[t][e]&&-10<this.Data[t][e]&&(s=this.WorldNumber+1,Mario.MarioCharacter.LevelString=s+"-",h=Mario.LevelType.Overground,1<this.Data[t][e]&&0==(3*Math.random()|0)&&(h=Mario.LevelType.Underground),this.Data[t][e]<0?(-2===this.Data[t][e]?(Mario.MarioCharacter.LevelString+="X",s+=2):-1===this.Data[t][e]?Mario.MarioCharacter.LevelString+="?":(Mario.MarioCharacter.LevelString+="#",s+=1),h=Mario.LevelType.Castle):Mario.MarioCharacter.LevelString+=this.Data[t][e],this.EnterLevel=!0,this.LevelDifficulty=s,this.LevelType=h),this.CanEnterLevel=!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&this.TryWalking(-1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)&&this.TryWalking(1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Up)&&this.TryWalking(0,-1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Down)&&this.TryWalking(0,1)),this.WaterSprite.Update(i),this.DecoSprite.Update(i),this.HelpSprite.Update(i),Mario.MarioCharacter.Large?(this.LargeMario.X=this.XMario+this.XMarioA*i|0,this.LargeMario.Y=this.YMario+(this.YMarioA*i|0)-22,this.LargeMario.Update(i)):(this.SmallMario.X=this.XMario+this.XMarioA*i|0,this.SmallMario.Y=this.YMario+(this.YMarioA*i|0)-6,this.SmallMario.Update(i)))},Mario.MapState.prototype.TryWalking=function(i,t){var e=this.XMario/16|0,s=this.YMario/16|0,h=e+i,a=s+t;this.Level[h][a]!==Mario.MapTile.Road&&this.Level[h][a]!==Mario.MapTile.Level||this.Level[h][a]===Mario.MapTile.Road&&0!==this.Data[h][a]&&0!==this.Data[e][s]&&-10<this.Data[e][s]||(this.XMarioA=8*i,this.YMarioA=8*t,this.MoveTime=2*this.CalcDistance(e,s,i,t)+1)},Mario.MapState.prototype.CalcDistance=function(i,t,e,s){for(var h=0;;){if(i+=e,t+=s,this.Level[i][t]!==Mario.MapTile.Road)return h;if(this.Level[i-s][t+e]===Mario.MapTile.Road)return h;if(this.Level[i+s][t-e]===Mario.MapTile.Road)return h;h++}},Mario.MapState.prototype.Draw=function(i){var t=0,e=0;if(8!==this.WorldNumber){for(i.drawImage(this.MapImage,0,0),e=0;e<=15;e++)for(t=20;0<=t;t--)this.Level[t][e]===Mario.MapTile.Water?this.IsWater(2*t-1,2*e-1)&&(this.WaterSprite.X=16*t-8,this.WaterSprite.Y=16*e-8,this.WaterSprite.Draw(i,this.camera)):this.Level[t][e]===Mario.MapTile.Decoration?(this.DecoSprite.X=16*t,this.DecoSprite.Y=16*e,this.DecoSprite.Draw(i,this.camera)):this.Level[t][e]===Mario.MapTile.Level&&-2===this.Data[t][e]&&(this.HelpSprite.X=16*t+16,this.HelpSprite.Y=16*e-16,this.HelpSprite.Draw(i,this.camera));Mario.MarioCharacter.Large?this.LargeMario.Draw(i,this.camera):this.SmallMario.Draw(i,this.camera),this.Font.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:4,Y:4},this.FontShadow.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:5,Y:5},this.Font.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:256,Y:4},this.FontShadow.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:257,Y:5},this.FontShadow.Draw(i,this.camera),this.Font.Draw(i,this.camera)}},Mario.MapState.prototype.LevelWon=function(){var i=this.XMario/16,t=this.YMario/16;-2===this.Data[i][t]?this.NextWorld():(this.Data[i][t]=-3!==this.Data[i][t]?0:-10,this.RenderStatic())},Mario.MapState.prototype.GetX=function(){return 160},Mario.MapState.prototype.GetY=function(){return 120},Mario.MapState.prototype.CheckForChange=function(i){8===this.WorldNumber&&i.ChangeState(new Mario.WinState),this.EnterLevel&&i.ChangeState(new Mario.LevelState(this.LevelDifficulty,this.LevelType))},Mario.LevelState=function(i,t){this.LevelDifficulty=i,this.LevelType=t,this.Layer=this.Level=null,this.BgLayer=[],this.Paused=!1,this.Font=this.FontShadow=this.FireballsToCheck=this.ShellsToCheck=this.Camera=this.SpritesToRemove=this.SpritesToAdd=this.Sprites=null,this.Delta=this.Tick=this.FireballsOnScreen=this.StartTime=this.TimeLeft=0,this.GotoLoseState=this.GotoMapState=!1},Mario.LevelState.prototype=new Enjine.GameState,Mario.LevelState.prototype.Enter=function(){var i,t,e=0,s=0,s=null;for(this.Level=new Mario.LevelGenerator(320,15).CreateLevel(this.LevelType,this.LevelDifficulty),this.Paused=!1,this.Layer=new Mario.LevelRenderer(this.Level,320,240),this.Sprites=new Enjine.DrawableManager,this.Camera=new Enjine.Camera,this.Tick=0,this.ShellsToCheck=[],this.FireballsToCheck=[],this.SpritesToAdd=[],this.SpritesToRemove=[],this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),e=0;e<2;e++)i=4>>e,s=320+((16*this.Level.Width-320)/i|0),t=240+((16*this.Level.Height-240)/i|0),s=new Mario.BackgroundGenerator(s/32+1,t/32+1,0===e,this.LevelType),this.BgLayer[e]=new Mario.BackgroundRenderer(s.CreateLevel(),320,240,i);Mario.MarioCharacter.Initialize(this),this.Sprites.Add(Mario.MarioCharacter),this.StartTime=1,this.TimeLeft=200,this.GotoLoseState=this.GotoMapState=!1},Mario.LevelState.prototype.Exit=function(){delete this.Level,delete this.Layer,delete this.BgLayer,delete this.Sprites,delete this.Camera,delete this.ShellsToCheck,delete this.FireballsToCheck,delete this.FontShadow,delete this.Font},Mario.LevelState.prototype.CheckShellCollide=function(i){this.ShellsToCheck.push(i)},Mario.LevelState.prototype.CheckFireballCollide=function(i){this.FireballsToCheck.push(i)},Mario.LevelState.prototype.Update=function(i){var t=0,e=0,s=e=0,h=null,t=!1,h=s=e=0,a=null,a=0;for(this.Delta=i,this.TimeLeft-=i,0==(0|this.TimeLeft)&&Mario.MarioCharacter.Die(),0<this.StartTime&&this.StartTime++,this.Camera.X=Mario.MarioCharacter.X-160,this.Camera.X<0&&(this.Camera.X=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),t=this.FireballsOnScreen=0;t<this.Sprites.Objects.length;t++)(h=this.Sprites.Objects[t])!==Mario.MarioCharacter&&(e=h.X-this.Camera.X,s=h.Y-this.Camera.Y,e<-64||384<e||s<-64||304<s?this.Sprites.RemoveAt(t):h instanceof Mario.Fireball&&this.FireballsOnScreen++);if(this.Paused)for(t=0;t<this.Sprites.Objects.length;t++)this.Sprites.Objects[t]===Mario.MarioCharacter?this.Sprites.Objects[t].Update(i):this.Sprites.Objects[t].UpdateNoMove(i);else{for(this.Layer.Update(i),this.Level.Update(),t=!1,this.Tick++,e=(this.Camera.X/16|0)-1;e<=1+((this.Camera.X+this.Layer.Width)/16|0);e++)for(s=(this.Camera.Y/16|0)-1;s<=1+((this.Camera.Y+this.Layer.Height)/16|0);s++)if(h=0,16*e+8>Mario.MarioCharacter.X+16&&(h=-1),16*e+8<Mario.MarioCharacter.X-16&&(h=1),null!==(a=this.Level.GetSpriteTemplate(e,s))&&(a.LastVisibleTick===this.Tick-1||null!==a.Sprite&&this.Sprites.Contains(a.Sprite)||a.Spawn(this,e,s,h),a.LastVisibleTick=this.Tick),0!==h&&(a=this.Level.GetBlock(e,s),0<(Mario.Tile.Behaviors[255&a]&Mario.Tile.Animated)&&3==(a%16/4|0)&&0==(a/16|0)&&(this.Tick-2*e)%100==0)){for(t=0;t<8;t++)this.AddSprite(new Mario.Sparkle(this,16*e+8,16*s+(16*Math.random()|0),Math.random()*h,0,0,1,5));this.AddSprite(new Mario.BulletBill(this,16*e+8+8*h,16*s+15,h)),t=!0}for(t&&Enjine.Resources.PlaySound("cannon"),t=0;t<this.Sprites.Objects.length;t++)this.Sprites.Objects[t].Update(i);for(t=0;t<this.Sprites.Objects.length;t++)this.Sprites.Objects[t].CollideCheck();for(t=0;t<this.ShellsToCheck.length;t++)for(e=0;e<this.Sprites.Objects.length;e++)this.Sprites.Objects[e]===this.ShellsToCheck[t]||this.ShellsToCheck[t].Dead||!this.Sprites.Objects[e].ShellCollideCheck(this.ShellsToCheck[t])||Mario.MarioCharacter.Carried!==this.ShellsToCheck[t]||this.ShellsToCheck[t].Dead||(Mario.MarioCharacter.Carried=null,this.ShellsToCheck[t].Die());for(t=this.ShellsToCheck.length=0;t<this.FireballsToCheck.length;t++)for(e=0;e<this.Sprites.Objects.length;e++)this.Sprites.Objects[e]!==this.FireballsToCheck[t]&&!this.FireballsToCheck[t].Dead&&this.Sprites.Objects[e].FireballCollideCheck(this.FireballsToCheck[t])&&this.FireballsToCheck[t].Die();this.FireballsToCheck.length=0}this.Sprites.AddRange(this.SpritesToAdd),this.Sprites.RemoveList(this.SpritesToRemove),this.SpritesToAdd.length=0,this.SpritesToRemove.length=0,this.Camera.X=Mario.MarioCharacter.XOld+(Mario.MarioCharacter.X-Mario.MarioCharacter.XOld)*i-160,this.Camera.Y=Mario.MarioCharacter.YOld+(Mario.MarioCharacter.Y-Mario.MarioCharacter.YOld)*i-120},Mario.LevelState.prototype.Draw=function(i){var t=0,t=0;for(this.Camera.X<0&&(this.Camera.X=0),this.Camera.Y<0&&(this.Camera.Y=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.Camera.Y>16*this.Level.Height-240&&(this.Camera.Y=16*this.Level.Height-240),t=0;t<2;t++)this.BgLayer[t].Draw(i,this.Camera);for(i.save(),i.translate(-this.Camera.X,-this.Camera.Y),t=0;t<this.Sprites.Objects.length;t++)0===this.Sprites.Objects[t].Layer&&this.Sprites.Objects[t].Draw(i,this.Camera);for(i.restore(),this.Layer.Draw(i,this.Camera),this.Layer.DrawExit0(i,this.Camera,0===Mario.MarioCharacter.WinTime),i.save(),i.translate(-this.Camera.X,-this.Camera.Y),t=0;t<this.Sprites.Objects.length;t++)1===this.Sprites.Objects[t].Layer&&this.Sprites.Objects[t].Draw(i,this.Camera);i.restore(),this.Layer.DrawExit1(i,this.Camera),this.DrawStringShadow(i,"MARIO "+Mario.MarioCharacter.Lives,0,0),this.DrawStringShadow(i,"00000000",0,1),this.DrawStringShadow(i,"COIN",14,0),this.DrawStringShadow(i," "+Mario.MarioCharacter.Coins,14,1),this.DrawStringShadow(i,"WORLD",24,0),this.DrawStringShadow(i," "+Mario.MarioCharacter.LevelString,24,1),this.DrawStringShadow(i,"TIME",34,0),(t=0|this.TimeLeft)<0&&(t=0),this.DrawStringShadow(i," "+t,34,1),0<this.StartTime&&(t=this.StartTime+this.Delta-2,this.RenderBlackout(i,160,120,t*t*.6|0)),0<Mario.MarioCharacter.WinTime&&(900<(t=(t=Mario.MarioCharacter.WinTime+this.Delta)*t*.2)&&(Mario.GlobalMapState.LevelWon(),this.GotoMapState=!0),this.RenderBlackout(i,Mario.MarioCharacter.XDeathPos-this.Camera.X|0,Mario.MarioCharacter.YDeathPos-this.Camera.Y|0,320-t|0)),0<Mario.MarioCharacter.DeathTime&&(900<(t=(t=Mario.MarioCharacter.DeathTime+this.Delta)*t*.1)&&(Mario.MarioCharacter.Lives--,this.GotoMapState=!0,Mario.MarioCharacter.Lives<=0)&&(this.GotoLoseState=!0),this.RenderBlackout(i,Mario.MarioCharacter.XDeathPos-this.Camera.X|0,Mario.MarioCharacter.YDeathPos-this.Camera.Y|0,320-t|0))},Mario.LevelState.prototype.DrawStringShadow=function(i,t,e,s){this.Font.Strings[0]={String:t,X:8*e+4,Y:8*s+4},this.FontShadow.Strings[0]={String:t,X:8*e+5,Y:8*s+5},this.FontShadow.Draw(i,this.Camera),this.Font.Draw(i,this.Camera)},Mario.LevelState.prototype.RenderBlackout=function(i,t,e,s){if(!(320<s)){for(var h=[],a=[],r=0,r=0;r<16;r++)h[r]=t+Math.cos(r*Math.PI/15)*s|0,a[r]=e+Math.sin(r*Math.PI/15)*s|0;for(h[16]=0,a[16]=e,h[17]=0,a[17]=240,h[18]=320,a[18]=240,h[19]=320,a[19]=e,i.fillStyle="#000",i.beginPath(),i.moveTo(h[19],a[19]),r=18;0<=r;r--)i.lineTo(h[r],a[r]);for(i.closePath(),i.fill(),r=0;r<16;r++)h[r]=t-Math.cos(r*Math.PI/15)*s|0,a[r]=e-Math.sin(r*Math.PI/15)*s|0;for(a[15]+=5,h[16]=320,a[16]=e,h[17]=320,a[17]=0,h[18]=0,a[18]=0,h[19]=0,a[19]=e,i.fillStyle="#000",i.beginPath(),i.moveTo(h[0],a[0]),r=0;r<=h.length-1;r++)i.lineTo(h[r],a[r]);i.closePath(),i.fill()}},Mario.LevelState.prototype.AddSprite=function(i){this.Sprites.Add(i)},Mario.LevelState.prototype.RemoveSprite=function(i){this.Sprites.Remove(i)},Mario.LevelState.prototype.Bump=function(i,t,e){var s=this.Level.GetBlock(i,t),h=0,a=0;if(0<(Mario.Tile.Behaviors[255&s]&Mario.Tile.Bumpable)&&(this.BumpInto(i,t-1),this.Level.SetBlock(i,t,4),this.Level.SetBlockData(i,t,4),0<(Mario.Tile.Behaviors[255&s]&Mario.Tile.Special)?(Enjine.Resources.PlaySound("sprout"),Mario.MarioCharacter.Large?this.AddSprite(new Mario.FireFlower(this,16*i+8,16*t+8)):this.AddSprite(new Mario.Mushroom(this,16*i+8,16*t+8))):(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.AddSprite(new Mario.CoinAnim(this,i,t)))),0<(Mario.Tile.Behaviors[255&s]&Mario.Tile.Breakable)&&(this.BumpInto(i,t-1),e))for(Enjine.Resources.PlaySound("breakblock"),this.Level.SetBlock(i,t,0),h=0;h<2;h++)for(a=0;a<2;a++)this.AddSprite(new Mario.Particle(this,16*i+8*h+4,16*t+8*a+4,4*(2*h-1),4*(2*a-1)-8))},Mario.LevelState.prototype.BumpInto=function(i,t){var e=this.Level.GetBlock(i,t),s=0;for(0<(Mario.Tile.Behaviors[255&e]&Mario.Tile.PickUpable)&&(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.Level.SetBlock(i,t,0),this.AddSprite(new Mario.CoinAnim(i,t+1))),s=0;s<this.Sprites.Objects.length;s++)this.Sprites.Objects[s].BumpCheck(i,t)},Mario.LevelState.prototype.CheckForChange=function(i){this.GotoLoseState?i.ChangeState(new Mario.LoseState):this.GotoMapState&&i.ChangeState(Mario.GlobalMapState)};